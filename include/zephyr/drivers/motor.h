/*
 * Copyright (c) 2024 ttwards <12411711@mail.sustech.edu.cn>
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/***
                                                                        ':l<-?--_-??_>l,'                                                                         
                                                                   ,~}\tt/([??_+<++]]}(\t/\]i"                                                                    
                                                               `~|jf{+l:` >]]x" }j[{~_1l;"l_)fr)i.                                                                
                                                             >fv(!::<t}j1 -|t}. _/([{Untmv{?+l"~tv\I                                                              
                                                           ?zx<'l|xcJ)<`;^;>~<~_-+<+~>!:>}}cci">``-un<                                                            
                                                         ~Ux; ~cjL/+!;~}{}->!:^`""":I!_}{]<!'^jmXt;`<zcI                                                          
                                                       'xC> !jvc{i^_|)~,.    ^>+.'I+)t- ';-(|<'IU0v|  ?0)                                                         
                                                      ^Ln..[Lmj".]j?"    '+rm*ZCm*B$k)"     :{j+.!II]|.,Cn                                                        
                                                     'Qx  I}x( ;u{'    ;rh$$$$@$$$$v   '.     "\f` (cz(.'Qn                                                       
                                                     xQ  ]r(, !X!     \W$$$$$$$$$$$CxUwahn'     -c""f/(} "b]                                                      
                                                    ;ai -CO|.^Y!     ($$$$$$$$$$$$$$$$$$$$~      }n ^(0n" )p.                                                     
                                                    /q `rcc+ {r      U$$$$$$$$$$$$$$$$$$$p^       Y> +wZ+ "b>                                                     
                                                    v0 .1mr" f-      >p@$$$$$&b#$$$@B$$$Q:        t1 ?zft. p{                                                     
                                                    nZ "n|[^ \{       .>)tt(--raMbm1d&J_          n] }j|> .p]                                                     
                                                    ?k`.~\v) <Y.           ')r|!'  ,)!           :U^'fuj_ >k"                                                     
                                                    .w| ;z/Yi /t         (bdbwOcJwddqm!         'v] >ztt` YX                                                      
                                                     ~k! +v\[. /t`       ._t}/k$$C)1/I         ;x[  "?t" }d,                                                      
                                                      }pl '  .' +v?'      !Mn ($W:,pO.       "{x(^      ]p>                                                       
                                                       ?m] .![O0OX}f};.    |@#8$$*8#l     'l)/_xBMz"" ./0!                                                        
                                                        ;Yv>}b$$&|  i|(}<;` >fzYYc(" ."I+{|r+: +dWWh~<Ux`                                                         
                                                          ?Xf)|j:"\{1hu;>-?[+}--?_+_]]?->, /MU~""I!rcc>                                                           
                                                           .-nx?"lYMWkf' !zX[w-",,f?}Y?   ]w%nr?;{uti                                                             
                                                              ;1xj1]l. ^)p$a%O!  ~8kw$C-' ;(]<1rr["                                                               
                                                                 ,+(ff|{?])+Z:   >cr})|j]{\t/)<^                                                                  
                                                                     `I+[{)rv//t//|\t/1{?<:'                                                                      
                                                                             .'''''                                                                               
                                                                                                                                                                  
                                                                                                                                                                  
                                                                          l+                                                                           "`         
               _qZ+                                                       t$u.                                                                        fMq:        
              I#$$|                                            .Il^       |$o'                                                .'              `l~vY+~U@$Br.       
           `i\a$$$8}                '[rt{_"                  '/k%Bo-      Y$w           lnr["    `~+:                        [koz.           ;bB$$$@@$$$%X'       
   .I>](nQb#@$$$aXxzQJt>            +$$$$$#c'              .?p$$$$$U  !jj-&B?           |$$$?    )$$o;",'                    Z$$L`>I.        1$$$$$$@@&Ofjnu\.    
   1aWW*pLvZ$$BOYw&$$$$p             !)n0W$*]<i"        .;|b$$$$$$$L+L8$o#M} xk}       .x$$@u). 'J$$$W&8d:                  <&@clx$@a-       }8B8$$$$kmbMobJ}.    
   .,:^ '_xM$$$ao$$$$$$0      .^;<?(trnJb%$a0pbx.       >nZp0Z%$$$$$#zb$8$u|dBp+   .1x0b%$$pXUrCh$$BYf)}<.                ^)#$$a@$&pY<        >X*$MOUQpW&C^       
       lw$$$$*\no%X?o$$\    "Xbo#apQYXm$$B$8ml'.       `>(JqZa$$$$$XIx$$@$W0t!     .\z(}&$@c++rxQ$$8YLY"        :-{}1(/rXZ#$$@kLt~"       .>f0#W0r/cko%$8j.       
     +L8Wqb&$Wk$$B|"W$@<    '<~!!>1umWBapo$$m;     iwqp*MkY|fa$$$$O.Y$&q8$|         `-um@$h. ]zwoZ*$$of`        /&$$@%*pQW$$#|~i;"`       :b%aZYzJYL0k@p<'";!I.   
 .~fb80]^^{d$$8B$ol;B$#,      IQo@$$$$%M$@Q_       :jc/-: ,d$$$$$Wl ~[:;W$]       :O8Mhm$$m|\)\Z$B$$8v?>,`     ''l-]][]|Q@$mZ&$$B8Md\      ":"I+++[M$$$Mo8%@$*^   
 IhBd~ ~qW$$*ZQ&$%Qn@$d.      "1jr{>va&ku<                ;cQxb$@)     n$m`       `fj,>$$W>^<Yh&WLxq%$$$BMmt' .<[nwaM&&#pc?.`[Yo$$$$W"      ;xXYJCJc0$$8zuvzc).   
  ^:.  :tmkmXnQ$p]lQ$$p              '".                      "?~     ^#$?            ')|I    `:"   l)zmmt>:.     "I!l,'       `-JW&J^             }Z$$J          
          .  ^O8c  ;rQ(                                              `U$$-                                                        ,,              ;bBBp!          
              ^l"                                                    _@$&>                                                                         'li'           

 */
 
 
/**
 * @file
 * @brief General Servo Motor Interface
 */

#ifndef ZEPHYR_INCLUDE_DRIVERS_MOTOR_H_
#define ZEPHYR_INCLUDE_DRIVERS_MOTOR_H_

/**
 * @brief Servo Motor Interface
 * @defgroup servo_motor_interface Servo Motor Interface
 * @since 3.7.99
 * @version 1.0.0
 * @ingroup io_interfaces
 * @{
 */

#include <sys/_intsup.h>
#include <zephyr/kernel.h>
#include "zephyr/logging/log_core.h"
#include <zephyr/kernel/thread.h>
#include <errno.h>
#include <zephyr/sys/util.h>

#include <stdint.h>
#include <zephyr/device.h>
#include <zephyr/devicetree.h>
#include <zephyr/logging/log.h>
#include <string.h>



#ifdef __cplusplus
extern "C" {
#endif

#define MOTOR_MODE_ANGLE 0
#define MOTOR_MODE_SPEED 1
#define MOTOR_MODE_TORQUE 2

#define MOTOR_DT_DRIVER_DATA_INST_GET(inst) {0}

#define DT_DRIVER_GET_CANBUS_IDT(node_id) DT_PHANDLE(node_id, can_channel)
#define DT_DRIVER_GET_CANPHY_IDT(node_id) \
		DT_PHANDLE(DT_DRIVER_GET_CANBUS_IDT(node_id), can_device)
#define DT_DRIVER_GET_CANBUS_NAME(node_id) \
		DT_NODE_FULL_NAME(DT_DRIVER_GET_CANBUS_IDT(node_id))

#define DT_GET_CANPHY(node_id) DEVICE_DT_GET(DT_DRIVER_GET_CANPHY_IDT(node_id))
#define DT_GET_CANPHY_BY_BUS(node_id) DEVICE_DT_GET(DT_PHANDLE(node_id, can_device))

#define MOTOR_DT_DRIVER_CONFIG_INST_GET(inst) \
	MOTOR_DT_DRIVER_CONFIG_GET(DT_DRV_INST(inst))

#define GET_CONTROLLER_STRUCT(node_id, prop, idx) \
	DEVICE_DT_GET(DT_PROP_BY_IDX(node_id, prop, idx))

/**
 * @brief Static initializer for @p motor_driver_config struct
 *
 * @param node_id Devicetree node identifier
 */
#define MOTOR_DT_DRIVER_CONFIG_GET(node_id)				\
	{ \
		.phy = DT_GET_CANPHY(node_id), \
		.canbus = DT_DRIVER_GET_CANBUS_NAME(node_id), \
		.tx_id = DT_PROP(node_id, tx_addr), \
		.rx_id = DT_PROP(node_id, rx_addr), \
		.compat = DT_PROP(node_id, compatible), \
		.controller = {DT_FOREACH_PROP_ELEM_SEP(node_id, controllers, GET_CONTROLLER_STRUCT, (,))}, \
		.capabilities = DT_PROP(node_id, capabilities), \
	}

#define MOTOR_DEVICE_DT_INST_DEFINE(inst, ...)   \
	MOTOR_DEVICE_DT_DEFINE(DT_DRV_INST(inst), __VA_ARGS__)

#define MOTOR_DEVICE_DT_DEFINE(node_id, init_fn, pm, data, config, level,	\
			     prio, api, ...)				\
	DEVICE_DT_DEFINE(node_id, init_fn, pm, data, config, level,	\
			 prio, api, __VA_ARGS__)

typedef uint8_t motor_mode_t;

struct motor_driver_data {
	/** Motor control mode */
	motor_mode_t mode;
};

struct motor_driver_config {
	/** Physical device */
	const struct device *phy;
	/** CAN Bus device */
	char canbus[12];
	/** CAN TX ID */
	uint32_t tx_id;
	/** CAN RX ID */
	uint32_t rx_id;
	/** Gear Ratio */
	char compat[16];
	uint8_t capabilities[4];
	struct device *controller[4];
};

/**
 * @typedef motor_get_status()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef float (*motor_api_stat_speed_t)(const struct device *dev);

/**
 * @typedef motor_get_status()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef float (*motor_api_stat_torque_t)(const struct device *dev);

/**
 * @typedef motor_get_status()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef float (*motor_api_stat_angle_t)(const struct device *dev);

/**
 * @typedef motor_set_speed()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef int8_t (*motor_api_speed_t)(const struct device *dev, float speed_rpm);

/**
 * @typedef motor_set_torque()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef int8_t (*motor_api_torque_t)(const struct device *dev, float torque);

/**
 * @typedef motor_set_angle()
 * @brief Callback API returning motor status
 *
 * @see get_status() for argument descriptions.
 */
typedef int8_t (*motor_api_angle_t)(const struct device *dev, float angle);


/**
 * @brief Servo Motor driver API
 */
__subsystem struct motor_driver_api {
	motor_api_stat_speed_t motor_get_speed;
	motor_api_stat_torque_t motor_get_torque;
    motor_api_stat_torque_t motor_get_angle;
	motor_api_speed_t motor_set_speed;
	motor_api_torque_t motor_set_torque;
	motor_api_angle_t motor_set_angle;
};

/**
 * @brief Motor error codes
 */
enum MotorError {
    MOTOR_SUCCESS = 0,
    MOTOR_ERROR_INIT = -1,
    MOTOR_ERROR_COMM = -2,
    MOTOR_ERROR_UNKNOWN = -3
};


/**
 * @brief Get Torque
 *
 * This routine retrieves the current torque of the motor.
 *
 * @param dev Motor Device
 * @return the current torque
 */
__syscall float motor_get_torque(const struct device *dev);

static inline float z_impl_motor_get_torque(const struct device *dev)
{
	const struct motor_driver_api *api =
		(const struct motor_driver_api *)dev->api;

	if (api->motor_get_torque == NULL) {
		return -ENOSYS;
	}
	return api->motor_get_torque(dev);
}

/**
 * @brief Get Speed
 *
 * This optional routine retrieves the current speed of the motor.
 *
 * @param dev Motor Device
 * @return the current speed in RPM
 */
__syscall float motor_get_speed(const struct device *dev);

static inline float z_impl_motor_get_speed(const struct device *dev)
{
	const struct motor_driver_api *api =
		(const struct motor_driver_api *)dev->api;

	if (api->motor_get_speed == NULL) {
		return -ENOSYS;
	}
	return api->motor_get_speed(dev);
}

__syscall float motor_get_angle(const struct device *dev);

static inline float z_impl_motor_get_angle(const struct device *dev)
{
    const struct motor_driver_api *api =
        (const struct motor_driver_api *)dev->api;

    if (api->motor_get_angle == NULL) {
        return -ENOSYS;
    }
    return api->motor_get_angle(dev);
}

/**
 * @brief Get Status
 *
 * This optional routine starts blinking a LED forever with the given time
 * period.
 *
 * @param dev Motor Device
 * @return 0 on success, negative on error
 */
__syscall int8_t motor_set_speed(const struct device *dev, float speed_rpm);

static inline int8_t z_impl_motor_set_speed(const struct device *dev, float speed_rpm)
{
	const struct motor_driver_api *api =
		(const struct motor_driver_api *)dev->api;

	if (api->motor_set_speed == NULL) {
		return -ENOSYS;
	}
	return api->motor_set_speed(dev, speed_rpm);
}

/**
 * @brief Get Status
 *
 * This optional routine starts blinking a LED forever with the given time
 * period.
 *
 * @param dev Motor Device
 * @return 0 on success, negative on error
 */
__syscall int8_t motor_set_angle(const struct device *dev, float angle);

static inline int8_t z_impl_motor_set_angle(const struct device *dev, float angle)
{
	const struct motor_driver_api *api =
		(const struct motor_driver_api *)dev->api;

	if (api->motor_set_angle == NULL) {
		return -ENOSYS;
	}
	return api->motor_set_angle(dev, angle);
}

/**
 * @brief Get Status
 *
 * This optional routine starts blinking a LED forever with the given time
 * period.
 *
 * @param dev Motor Device
 * @return 0 on success, negative on error
 */
__syscall int8_t motor_set_torque(const struct device *dev, float torque);

static inline int8_t z_impl_motor_set_torque(const struct device *dev, float torque)
{
  const struct motor_driver_api *api =
    (const struct motor_driver_api *)dev->api;

  if (api->motor_set_torque == NULL) {
    return -ENOSYS;
  }
  return api->motor_set_torque(dev, torque);
}

/**
 * @}
 */

#ifdef __cplusplus
}
#endif

#include <zephyr/syscalls/motor.h>

#endif	/* ZEPHYR_INCLUDE_DRIVERS_MOTOR_H_ */